<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AFK Mode â€” Earn while youâ€™re AFK ðŸ’¤</title>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.js"></script>

  <script>
    const BACKEND_URL = "https://api.afkcoin.xyz";
  </script>
  <style>
    :root{
      --bg:#0b1115;--panel:#111a20;--accent:#39ff88;--accent2:#6be3ff;--muted:#8aa3b4;--danger:#ff5773;
    }
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 20% -10%, #0f1b24, #0b1115 40%), #0b1115;color:#e9f1f7;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:24px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));border:1px solid rgba(255,255,255,.08);border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:24px}
    h1{margin:0 0 8px;font-size:clamp(26px,4vw,40px);letter-spacing:.5px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px;margin-top:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .stat{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    .stat h3{margin:0 0 6px;font-size:1rem;color:var(--muted)}
    .big{font-size:clamp(28px,6vw,48px);font-weight:800;letter-spacing:.5px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition:transform .1s ease}
    .btn:active{transform:scale(.95)}
    .btn:disabled{cursor:not-allowed;opacity:.5}
    .btn-primary{background:linear-gradient(90deg,var(--accent),#7bffb8);color:#052012;box-shadow:0 6px 20px rgba(57,255,136,.35)}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.18);color:#e9f1f7}
    .btn-ghost{background:transparent;color:var(--muted)}
    .pill{display:inline-block;border:1px dashed rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:.9rem}
    .neon{color:var(--accent);text-shadow:0 0 6px rgba(57,255,136,.7), 0 0 18px rgba(57,255,136,.35)}
    .log{height:200px;overflow:auto;background:#0b1217;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px;font-family:ui-monospace,Consolas,monospace;font-size:.9rem}
    .muted{color:var(--muted)}
    .boosters-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;text-align:center;margin-top:16px}
    .booster-card{background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    .booster-card h4{margin:0 0 8px;font-size:1.1rem}
    .booster-card .cost{font-size:1.2rem;font-weight:700;color:var(--accent2)}
    @media(max-width:600px){.boosters-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h1>AFK Mode <span class="neon">â€” Activa y Gana ðŸš€</span></h1>
        <div class="row">
          <button id="connect" class="btn btn-outline" disabled>Buscando Wallet...</button>
          <span id="pubkey" class="pill">Wallet: desconectada</span>
          <span id="afk-balance" class="pill">$AFK: --</span>
        </div>
      </div>
      <p class="muted">Gasta <b class="neon">$AFK</b> para activar un Booster. Mantente AFK para recibir premios aleatorios en <b class="neon">Zâ€‘Points</b>.
      </p>

      <div class="grid">
        <section class="card">
          <h3>Elige tu Booster para empezar</h3>
          <div id="boosters" class="boosters-grid">
            <div class="booster-card">
              <h4>Booster BÃ¡sico</h4>
              <p class="cost">Coste: 10 $AFK</p>
              <p class="muted" style="font-size:.8rem">Premios pequeÃ±os. Jackpot bajo.</p>
              <button class="btn btn-outline" data-booster="basico">Activar</button>
            </div>
            <div class="booster-card">
              <h4>Booster Raro</h4>
              <p class="cost">Coste: 50 $AFK</p>
              <p class="muted" style="font-size:.8rem">Mejores premios. Jackpot decente.</p>
              <button class="btn btn-outline" data-booster="raro">Activar</button>
            </div>
            <div class="booster-card">
              <h4>Booster Legendario</h4>
              <p class="cost">Coste: 250 $AFK</p>
              <p class="muted" style="font-size:.8rem">Premios altos. Â¡Jackpot masivo!</p>
              <button class="btn btn-outline" data-booster="legendario">Activar</button>
            </div>
          </div>
          <div id="afk-display" style="display:none;">
            <div class="row" style="gap:20px">
              <div class="stat"><h3>Tiempo AFK</h3><div id="afkTime" class="big">0:00</div></div>
              <div class="stat"><h3>Ganancia (sesiÃ³n)</h3><div id="pointsSession" class="big neon">0</div></div>
            </div>
            <div class="row" style="margin-top:16px">
              <button id="stop" class="btn btn-primary">Terminar SesiÃ³n y Guardar</button>
            </div>
          </div>
        </section>

        <aside class="card">
          <div class="stat">
            <h3>Mis Z-Points (local)</h3>
            <div class="big" id="pointsTotal">0</div>
          </div>
          <div style="margin-top:12px" class="row">
            <button id="ranking" class="btn btn-outline">Ver Ranking</button>
            <button id="reset" class="btn btn-ghost">Reset local</button>
          </div>
        </aside>
      </div>

      <h3 style="margin:22px 0 8px">Actividad Reciente</h3>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    const AFK_TOKEN_MINT_ADDRESS = '1THEbQ2K1ELPQcsgfWhbSyApMeiXhofRexvmTVFvDfX';
    const TREASURY_WALLET_ADDRESS = 'F3zY8TZ9jiCTneBkPQr1DMbyT9vgwdBUXCoZB9h4GP5G';
    const connection = new solanaWeb3.Connection('https://mainnet.rpc.solaxy.io');

    const BOOSTERS = { /* ... */ }; // (Omitido por brevedad, es igual que antes)
    const state = { /* ... */ }; // (Omitido por brevedad, es igual que antes)

    // (Funciones de utilidad y renderizado sin cambios)
    const $ = sel => document.querySelector(sel);
    const log = (msg) => { const box = $('#log'); const t=new Date().toLocaleTimeString(); box.innerHTML = `[${t}] ${msg}<br>` + box.innerHTML; }
    const fmt = (s)=>{ const m=Math.floor(s/60), ss=String(Math.floor(s%60)).padStart(2,'0'); return `${m}:${ss}` };
    function render(){ /* ... */ }
    function toggleViews(showAFK) { /* ... */ }
    function calculateRewardDrop() { /* ... */ }
    
    // (Funciones de lÃ³gica de juego sin cambios)
    let loop;
    async function startAFK(boosterType) { /* ... */ }
    async function stopAFK(reason = 'botÃ³n Detener') { /* ... */ }
    
    // (Listeners de eventos y botones sin cambios)
    
    // <<< CAMBIO: LÃ“GICA DE CONEXIÃ“N COMPLETAMENTE REESCRITA >>>

    async function handleConnection(publicKey) {
      const key = publicKey.toString();
      state.pubkey = key;
      $('#pubkey').textContent = `Wallet: ${key.slice(0,6)}â€¦${key.slice(-6)}`;
      $('#connect').textContent = 'Conectado';
      $('#connect').disabled = true;
      log('Wallet conectada âœ…');
      await updateAfkBalance(key);
    }

    function handleDisconnection() {
      state.pubkey = null;
      $('#pubkey').textContent = 'Wallet: desconectada';
      $('#afk-balance').textContent = '$AFK: --';
      $('#connect').textContent = 'Conectar wallet';
      $('#connect').disabled = false;
      log('Wallet desconectada.');
    }

    async function connectWallet(){
      if (!state.provider) {
        log('Wallet no disponible.');
        return;
      }
      try {
        const resp = await state.provider.connect();
        // La publicKey estarÃ¡ en resp.publicKey si la conexiÃ³n es nueva
        // o directamente en state.provider.publicKey si ya estaba conectada
        const publicKey = resp.publicKey || state.provider.publicKey;
        await handleConnection(publicKey);
      } catch(err) { 
        log('ConexiÃ³n rechazada por el usuario.'); 
        console.error(err);
      }
    }

    function initializeApp() {
        const provider = window.solaxy || window.solana;
        const connectButton = $('#connect');

        if (provider) {
            state.provider = provider;
            connectButton.disabled = false;
            connectButton.textContent = 'Conectar wallet';
            log('Wallet detectada. Â¡Lista para conectar!');
            
            // Escuchamos eventos de la wallet
            provider.on('connect', handleConnection);
            provider.on('disconnect', handleDisconnection);

            // Intentamos una conexiÃ³n silenciosa (eager connect)
            if (provider.isAutoApprove) {
              provider.connect({ onlyIfTrusted: true }).catch(() => {
                // Falla silenciosamente si el usuario no ha aprobado antes
                log('Haz clic en "Conectar wallet" para empezar.');
              });
            } else {
               log('Haz clic en "Conectar wallet" para empezar.');
            }
        } else {
            connectButton.textContent = 'Wallet no encontrada';
            log('No se detectÃ³ una wallet compatible (Solaxy o Phantom).');
        }
    }
    
    // (Event listeners para botones de la app)
    window.addEventListener('load', initializeApp);
    $('#connect').addEventListener('click', connectWallet);
    // ...resto de listeners...

  </script>
</body>
</html>