<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AFK Mode ‚Äî Earn while you‚Äôre AFK üí§</title>
  <script>
    const BACKEND_URL = "https://api.afkcoin.xyz";
  </script>
  <style>
    :root{
      --bg:#0b1115;--panel:#111a20;--accent:#39ff88;--accent2:#6be3ff;--muted:#8aa3b4;--danger:#ff5773;
    }
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 20% -10%, #0f1b24, #0b1115 40%), #0b1115;color:#e9f1f7;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:24px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));border:1px solid rgba(255,255,255,.08);border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:24px}
    h1{margin:0 0 8px;font-size:clamp(26px,4vw,40px);letter-spacing:.5px}
    .tag{display:inline-flex;gap:8px;align-items:center;background:#0f1720;border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:.9rem}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px;margin-top:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .stat{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    .stat h3{margin:0 0 6px;font-size:1rem;color:var(--muted)}
    .big{font-size:clamp(28px,6vw,48px);font-weight:800;letter-spacing:.5px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent),#7bffb8);color:#052012;box-shadow:0 6px 20px rgba(57,255,136,.35)}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.18);color:#e9f1f7}
    .btn-ghost{background:transparent;color:var(--muted)}
    .pill{display:inline-block;border:1px dashed rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:.9rem}
    .neon{color:var(--accent);text-shadow:0 0 6px rgba(57,255,136,.7), 0 0 18px rgba(57,255,136,.35)}
    .neon-blue{color:var(--accent2);text-shadow:0 0 8px rgba(107,227,255,.7)}
    .progress{height:10px;background:#0f1720;border:1px solid rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent2),var(--accent));transition:width .3s ease}
    .log{height:160px;overflow:auto;background:#0b1217;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px;font-family:ui-monospace,Consolas,monospace;font-size:.9rem}
    .muted{color:var(--muted)}
    .footer{margin-top:18px;font-size:.9rem;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h1>AFK Mode <span class="neon">‚Äî Earn while you‚Äôre AFK üí§</span></h1>
        <div class="row">
          <button id="connect" class="btn btn-outline">Conectar wallet</button>
          <span id="pubkey" class="pill">Wallet: desconectada</span>
        </div>
      </div>
      <p class="muted">Gana <b class="neon">Z‚ÄëPoints</b> por cada segundo que est√©s inactivo (AFK). Si mueves el rat√≥n, pulsas teclas o tocas la pantalla, el combo AFK se rompe.
      </p>

      <div class="grid">
        <section class="card">
          <div class="row" style="gap:20px">
            <div class="stat"><h3>Tiempo AFK (sesi√≥n)</h3><div id="afkTime" class="big">0:00</div></div>
            <div class="stat"><h3>Z‚ÄëPoints (sesi√≥n)</h3><div id="pointsSession" class="big neon">0</div></div>
            <div class="stat"><h3>Combo AFK</h3><div id="combo" class="big neon-blue">x1.00</div></div>
          </div>
          <div style="margin:14px 0 8px" class="muted">Progreso hasta bonus</div>
          <div class="progress"><div id="bar" class="bar"></div></div>
          <div class="row" style="margin-top:16px">
            <button id="start" class="btn btn-primary">Entrar en modo AFK</button>
            <button id="stop" class="btn btn-outline">Romper AFK</button>
            <span class="pill">Bonus cada 60s AFK continuos</span>
          </div>
        </section>

        <aside class="card">
          <div class="stat">
            <h3>Total hist√≥rico</h3>
            <div class="big" id="pointsTotal">0 Z‚ÄëPoints</div>
            <div class="muted" id="sessions">Sesiones AFK: 0</div>
          </div>
          <div style="margin-top:12px" class="row">
            <button id="claim" class="btn btn-primary">(Demo) Reclamar Z‚ÄëPoints</button>
            <button id="ranking" class="btn btn-outline">Ver Ranking</button>
            <button id="reset" class="btn btn-ghost">Reset local</button>
          </div>
          <p class="muted" style="margin-top:10px">La funci√≥n ‚ÄúReclamar‚Äù es un <b>stub</b>: aqu√≠ conectar√≠amos el contrato para canjear puntos por <b>$AFK</b> en airdrops semanales. 
            El c√≥digo expone <code>onClaim()</code> para que lo enlaces a tu backend/contrato cuando est√© listo.
          </p>
        </aside>
      </div>

      <h3 style="margin:22px 0 8px">Actividad</h3>
      <div id="log" class="log"></div>

      <div class="footer">Tip: deja la pesta√±a activa y <b>no toques nada</b>. Cada 60s de AFK ganas un bonus multiplicador. Mover el rat√≥n o teclear reinicia el combo.
      </div>
    </div>
  </div>

  <script>
    // ====== Estado ======
    const state = {
      running:false,
      lastActivity: Date.now(),
      afkStart: null,
      secondsAFK: 0,
      combo: 1,
      sessionPoints: 0,
      bonusCycle: 60, // segundos necesarios para bonus
      totalPoints: Number(localStorage.getItem('afk_total_points')||0),
      sessions: Number(localStorage.getItem('afk_sessions')||0),
      pubkey: null, // <<< CAMBIO: para guardar la pubkey de la wallet
    };

    // ====== Utilidades ======
    const $ = sel => document.querySelector(sel);
    const log = (msg) => { const box = $('#log'); const t=new Date().toLocaleTimeString(); box.innerHTML = `[${t}] ${msg}<br>` + box.innerHTML; }
    const fmt = (s)=>{ const m=Math.floor(s/60), ss=String(Math.floor(s%60)).padStart(2,'0'); return `${m}:${ss}` };

    // ====== UI ======
    function render(){
      $('#pointsSession').textContent = state.sessionPoints.toFixed(0);
      $('#pointsTotal').textContent = `${state.totalPoints.toFixed(0)} Z‚ÄëPoints`;
      $('#sessions').textContent = `Sesiones AFK: ${state.sessions}`;
      $('#afkTime').textContent = fmt(state.secondsAFK);
      $('#combo').textContent = `x${state.combo.toFixed(2)}`;
      const cycleProgress = Math.min(1, (state.secondsAFK % state.bonusCycle)/state.bonusCycle);
      $('#bar').style.width = (cycleProgress*100).toFixed(1)+"%";
    }

    // ====== AFK loop ======
    let loop;
    function startAFK(){
      if(state.running) return; 
      state.running = true; state.afkStart = Date.now(); state.secondsAFK=0; state.combo=1; state.sessionPoints=0;
      state.sessions += 1; localStorage.setItem('afk_sessions', state.sessions);
      log('Modo AFK iniciado. No toques nada‚Ä¶ üí§');
      loop = setInterval(()=>{
        state.secondsAFK = (Date.now() - state.afkStart)/1000;
        state.sessionPoints += 1 * state.combo;
        if(Math.floor(state.secondsAFK) > 0 && Math.floor(state.secondsAFK) % state.bonusCycle === 0){
          state.combo = Math.min(5, state.combo * 1.10);
          log(`üéÅ Bonus AFK: combo ahora ${state.combo.toFixed(2)}x`);
        }
        render();
      }, 1000);
    }

    // <<< CAMBIO: La funci√≥n ahora es async para usar await con fetch
    async function breakAFK(reason='Actividad detectada'){
      if(!state.running) return;
      clearInterval(loop); state.running=false;
      const gained = Math.floor(state.sessionPoints);
      state.totalPoints += gained; localStorage.setItem('afk_total_points', state.totalPoints);
      log(`AFK terminado (${reason}). Ganaste +${gained} Z‚ÄëPoints en esta sesi√≥n.`);

      // <<< CAMBIO: L√≥gica para guardar puntos en el backend
      if(state.pubkey && gained > 0){
        log(`Enviando ${gained} puntos al backend para ${state.pubkey.slice(0,6)}...`);
        try {
          const res = await fetch(`${BACKEND_URL}/savePoints`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pubkey: state.pubkey, points: gained })
          });
          const data = await res.json();
          if(data.ok){
            log('‚úÖ Puntos guardados en el servidor.');
          } else {
            log(`‚ùå Error del backend: ${data.error || 'desconocido'}`);
          }
        } catch(err){
          console.error(err);
          log('‚ùå No se pudo conectar con el backend para guardar los puntos.');
        }
      } else if (gained > 0) {
        log('‚ÑπÔ∏è Conecta tu wallet para guardar los puntos en el ranking global.');
      }
      render();
    }

    // Eventos de actividad que rompen el AFK
    ['mousemove','mousedown','keydown','touchstart','wheel'].forEach(evt=>{
      window.addEventListener(evt, ()=>{ if(state.running){ breakAFK('actividad del usuario'); } });
    });

    // Botones
    $('#start').addEventListener('click', startAFK);
    $('#stop').addEventListener('click', ()=>breakAFK('bot√≥n Detener'));
    $('#reset').addEventListener('click', ()=>{ localStorage.removeItem('afk_total_points'); localStorage.removeItem('afk_sessions'); state.totalPoints=0; state.sessions=0; log('‚úÖ Datos locales reseteados'); render(); });

    // Stub de claim (aqu√≠ conectar√≠as tu backend/contrato)
    function onClaim(){
      const amount = Math.floor(state.totalPoints);
      if(amount<=0){ log('Nada que reclamar a√∫n.'); return; }
      log(`(Demo) Reclamaci√≥n enviada por ${amount} Z‚ÄëPoints ‚Üí airdrop semanal $AFK`);
      state.totalPoints = 0; localStorage.setItem('afk_total_points', 0); render();
    }
    $('#claim').addEventListener('click', onClaim);

    // ====== Conexi√≥n de wallet (Phantom/Solaxy Wallet) ======
    async function connectWallet(){
      try{
        const provider = window.phantom?.solana || window.solana || window.solaxy;
        if(!provider){ log('No se detect√≥ wallet compatible. Instala Phantom o Solaxy Wallet.'); return; }
        const res = await provider.connect();
        const key = res.publicKey?.toString?.() || res.address || 'conectada';
        state.pubkey = key; // <<< CAMBIO: Guardamos la pubkey en el estado
        $('#pubkey').textContent = `Wallet: ${key.slice(0,6)}‚Ä¶${key.slice(-6)}`;
        log('Wallet conectada ‚úÖ');
      }catch(err){
        console.error(err); log('Error al conectar wallet.');
      }
    }
    $('#connect').addEventListener('click', connectWallet);

    // <<< CAMBIO: Nueva funci√≥n y evento para el ranking
    async function getRanking(){
      log('Consultando el ranking...');
      try {
        const res = await fetch(`${BACKEND_URL}/ranking`);
        const data = await res.json();
        if(data.ok && data.ranking){
          log('üèÜ Ranking Top 20:');
          data.ranking.forEach((p, i) => {
            log(`${i+1}. ${p.pubkey.slice(0,6)}...${p.pubkey.slice(-6)} ‚Äî ${p.points} puntos`);
          });
        } else {
          log(`‚ùå Error del backend: ${data.error || 'desconocido'}`);
        }
      } catch(err) {
        console.error(err);
        log('‚ùå No se pudo conectar con el backend para obtener el ranking.');
      }
    }
    $('#ranking').addEventListener('click', getRanking);

    render();
  </script>
</body>
</html>