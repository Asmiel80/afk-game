<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AFK Mode ‚Äî Earn while you‚Äôre AFK üí§</title>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <script src="https://unpkg.com/spl-token@0.3.11/lib/index.iife.js"></script>

  <script>
    const BACKEND_URL = "https://api.afkcoin.xyz";
    const IGNITER_URL = 'https://igniter.solaxy.io/token/?mint=1THEbQ2K1ELPQcsgfWhbSyApMeiXhofRexvmTVFvDfX';
  </script>
  <style>
    :root{
      --bg:#0b1115;--panel:#111a20;--accent:#39ff88;--accent2:#6be3ff;--muted:#8aa3b4;--danger:#ff5773;
    }
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 20% -10%, #0f1b24, #0b1115 40%), #0b1115;color:#e9f1f7;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:24px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));border:1px solid rgba(255,255,255,.08);border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:24px}
    h1{margin:0 0 8px;font-size:clamp(26px,4vw,40px);letter-spacing:.5px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px;margin-top:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .stat{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    .stat h3{margin:0 0 6px;font-size:1rem;color:var(--muted)}
    .big{font-size:clamp(28px,6vw,48px);font-weight:800;letter-spacing:.5px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition:transform .1s ease}
    .btn:active{transform:scale(.95)}
    .btn:disabled{cursor:not-allowed;opacity:.5}
    .btn-primary{background:linear-gradient(90deg,var(--accent),#7bffb8);color:#052012;box-shadow:0 6px 20px rgba(57,255,136,.35)}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.18);color:#e9f1f7}
    .btn-ghost{background:transparent;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;border:1px dashed rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:.9rem}
    .neon{color:var(--accent);text-shadow:0 0 6px rgba(57,255,136,.7), 0 0 18px rgba(57,255,136,.35)}
    .neon-blue{color:var(--accent2);text-shadow:0 0 6px rgba(107,227,255,.7)}
    .log{height:200px;overflow:auto;background:#0b1217;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px;font-family:ui-monospace,Consolas,monospace;font-size:.9rem}
    .muted{color:var(--muted)}
    .boosters-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;text-align:center;margin-top:16px}
    .booster-card{background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    .booster-card h4{margin:0 0 8px;font-size:1.1rem}
    .booster-card .cost{font-size:1.2rem;font-weight:700;color:var(--accent2);line-height:1.4;}
    @media(max-width:600px){.boosters-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h1>AFK Mode <span class="neon">‚Äî Paga y Gana üöÄ</span></h1>
        <div class="row">
          <button id="connect" class="btn btn-outline">Conectar Wallet</button>
          <span id="pubkey" class="pill">Wallet: desconectada</span>
        </div>
      </div>
      <p class="muted">Compra un Booster con <b class="neon-blue">SOLX</b> para empezar a ganar <b class="neon">Z‚ÄëPoints</b>. Conecta tu wallet para guardar tu puntuaci√≥n en el ranking global.</p>

      <div class="grid">
        <section class="card">
          <h3>Elige tu Booster para empezar</h3>
          <div id="boosters" class="boosters-grid">
            <div class="booster-card">
              <h4>Booster B√°sico</h4>
              <p class="cost">1‚Ç¨ <br><span class="muted" style="font-size:1rem;" id="costBasicoSolx">~---- SOLX</span></p>
              <button class="btn btn-outline" data-booster="basico">Activar</button>
            </div>
            <div class="booster-card">
              <h4>Booster Raro</h4>
              <p class="cost">3‚Ç¨ <br><span class="muted" style="font-size:1rem;" id="costRaroSolx">~---- SOLX</span></p>
              <button class="btn btn-outline" data-booster="raro">Activar</button>
            </div>
            <div class="booster-card">
              <h4>Booster Legendario</h4>
              <p class="cost">7‚Ç¨ <br><span class="muted" style="font-size:1rem;" id="costLegendarioSolx">~---- SOLX</span></p>
              <button class="btn btn-outline" data-booster="legendario">Activar</button>
            </div>
          </div>
          <div id="afk-display" style="display:none;">
            <div class="row" style="gap:20px">
              <div class="stat"><h3>Tiempo AFK</h3><div id="afkTime" class="big">0:00</div></div>
              <div class="stat"><h3>Ganancia (sesi√≥n)</h3><div id="pointsSession" class="big neon">0</div></div>
            </div>
            <div class="row" style="margin-top:16px">
              <button id="stop" class="btn btn-primary">Terminar Sesi√≥n</button>
            </div>
          </div>
        </section>

        <aside class="card">
          <div class="stat">
            <h3>Mis Z-Points</h3>
            <div class="big" id="pointsTotal">0</div>
          </div>
           <div style="margin-top:16px;">
            <button id="buyAfk" class="btn btn-primary" style="width:100%;">Comprar el Token $AFK</button>
          </div>
          <div style="margin-top:12px" class="row">
            <button id="ranking" class="btn btn-outline">Ver Ranking</button>
            <button id="reset" class="btn btn-ghost">Reset Puntos</button>
          </div>
        </aside>
      </div>

      <h3 style="margin:22px 0 8px">Actividad Reciente</h3>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    const SOLX_MINT_ADDRESS = 'Cf2LnRpmcUxY8qkAyiaaPpgAtUHgzkH3tPhMAevE9zLg';
    const TREASURY_WALLET_ADDRESS = 'F3zY8TZ9jiCTneBkPQr1DMbyT9vgwdBUXCoZB9h4GP5G';
    const USDC_MINT_ADDRESS = 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyB7u6T';
    const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));

    const BOOSTER_PRICES_EUR = { basico: 1, raro: 3, legendario: 7 };
    const BOOSTERS_REWARDS = {
      basico: { rewards: { jackpot: 1000, high: 200, mid: 50, low: 10 }, probs: { jackpot: 0.01, high: 0.05, mid: 0.2 } },
      raro: { rewards: { jackpot: 10000, high: 1000, mid: 250, low: 50 }, probs: { jackpot: 0.02, high: 0.08, mid: 0.25 } },
      legendario: { rewards: { jackpot: 250000, high: 5000, mid: 1000, low: 200 }, probs: { jackpot: 0.005, high: 0.1, mid: 0.3 } },
    };

    const state = {
      provider: null, running: false, afkStart: null, sessionPoints: 0,
      totalPoints: 0, pubkey: null, activeBooster: null,
      solxPrice: null
    };

    const $ = sel => document.querySelector(sel);
    const log = (msg) => { const box = $('#log'); const t=new Date().toLocaleTimeString(); box.innerHTML = `[${t}] ${msg}<br>` + box.innerHTML; };
    const fmt = (s) => { const m=Math.floor(s/60), ss=String(Math.floor(s%60)).padStart(2,'0'); return `${m}:${ss}` };

    function render(){
      $('#pointsSession').textContent = state.sessionPoints.toFixed(0);
      $('#pointsTotal').textContent = state.totalPoints.toFixed(0);
      $('#afkTime').textContent = fmt(state.secondsAFK);
      document.querySelectorAll('.booster-card button').forEach(btn => {
        btn.disabled = !state.pubkey || !state.solxPrice || state.running;
      });
    }

    async function savePointsToServer() {
      if (!state.pubkey) return;
      try {
        await fetch(`${BACKEND_URL}/savePoints`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pubkey: state.pubkey, points: state.totalPoints })
        });
        log('Puntuaci√≥n sincronizada con el servidor.');
      } catch (err) { 
        log('‚ùå No se pudo sincronizar con el ranking.'); 
      }
    }

    async function loadPointsFromServer(pubkey) {
      log('Buscando puntuaci√≥n guardada en el servidor...');
      try {
        const res = await fetch(`${BACKEND_URL}/points/${pubkey}`);
        const data = await res.json();
        if (data.ok) {
          log(`Puntuaci√≥n del servidor: ${data.points}.`);
          state.totalPoints = data.points;
          localStorage.setItem('afk_total_points', state.totalPoints);
        }
      } catch (err) {
        log('‚ùå No se pudo conectar con el servidor para cargar la puntuaci√≥n.');
      } finally {
        render();
      }
    }

    async function connectWallet() {
      const provider = window.solana;
      if (!provider || !provider.isPhantom) {
        log('‚ùå Wallet Phantom no detectada. Por favor, inst√°lala.');
        return;
      }
      try {
        const resp = await provider.connect();
        state.provider = provider;
        const key = resp.publicKey.toString();
        state.pubkey = key;
        $('#connect').textContent = 'Wallet Conectada';
        $('#connect').disabled = true;
        $('#pubkey').textContent = `Wallet: ${key.slice(0,6)}‚Ä¶${key.slice(-6)}`;
        log('Wallet conectada.');
        await loadPointsFromServer(key);
      } catch(err) { 
        log('‚ùå Conexi√≥n rechazada por el usuario.'); 
        console.error(err);
      }
    }

    async function fetchSolxPrice() {
      try {
        log('Obteniendo precio de SOLX desde Jupiter...');
        const jupiterApiUrl = `https://price.jup.ag/v4/price?ids=${SOLX_MINT_ADDRESS}&vsToken=${USDC_MINT_ADDRESS}`;
        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(jupiterApiUrl)}`;

        const res = await fetch(proxyUrl);
        if (!res.ok) throw new Error(`Proxy request failed`);
        
        const proxiedData = await res.json();
        const data = JSON.parse(proxiedData.contents);

        const price = data.data[SOLX_MINT_ADDRESS]?.price;
        if (typeof price !== 'number') throw new Error('Price not found in Jupiter API response');

        state.solxPrice = price;
        log(`Precio actual de SOLX: ~${price.toFixed(6)} ‚Ç¨ (en USDC)`);
        updatePricesUI();
      } catch (err) {
        log('‚ùå No se pudo obtener el precio de SOLX. Los botones de activar estar√°n desactivados.');
        console.error("Error detallado al obtener precio:", err);
      }
    }

    function updatePricesUI() {
      if (!state.solxPrice) return;
      const costBasico = (BOOSTER_PRICES_EUR.basico / state.solxPrice).toLocaleString('es-ES', { maximumFractionDigits: 0 });
      const costRaro = (BOOSTER_PRICES_EUR.raro / state.solxPrice).toLocaleString('es-ES', { maximumFractionDigits: 0 });
      const costLegendario = (BOOSTER_PRICES_EUR.legendario / state.solxPrice).toLocaleString('es-ES', { maximumFractionDigits: 0 });
      $('#costBasicoSolx').textContent = `~${costBasico} SOLX`;
      $('#costRaroSolx').textContent = `~${costRaro} SOLX`;
      $('#costLegendarioSolx').textContent = `~${costLegendario} SOLX`;
      render();
    }
    
    let loop;
    async function startAFK(boosterType) {
      if (!state.pubkey || state.running || !state.solxPrice) {
        log('Conecta tu wallet para poder jugar.');
        return;
      }

      const provider = state.provider;
      const solxAmount = BOOSTER_PRICES_EUR[boosterType] / state.solxPrice;
      log(`Iniciando compra de Booster con ${solxAmount.toFixed(2)} SOLX...`);

      try {
        const mintPublicKey = new solanaWeb3.PublicKey(SOLX_MINT_ADDRESS);
        const treasuryPublicKey = new solanaWeb3.PublicKey(TREASURY_WALLET_ADDRESS);
        const userPublicKey = new solanaWeb3.PublicKey(state.pubkey);
        
        const fromTokenAccount = await splToken.getAssociatedTokenAddress(mintPublicKey, userPublicKey);
        const toTokenAccount = await splToken.getAssociatedTokenAddress(mintPublicKey, treasuryPublicKey);
        
        const solxDecimals = 9;
        const amount = Math.ceil(solxAmount * (10 ** solxDecimals));
        
        const transferInstruction = splToken.createTransferInstruction(fromTokenAccount, toTokenAccount, userPublicKey, amount);
        const transaction = new solanaWeb3.Transaction().add(transferInstruction);
        const { blockhash } = await connection.getLatestBlockhash();
        transaction.recentBlockhash = blockhash;
        transaction.feePayer = userPublicKey;
        
        const signedTransaction = await provider.signTransaction(transaction);
        const signature = await connection.sendRawTransaction(signedTransaction.serialize());
        await connection.confirmTransaction(signature, 'confirmed');

        log(`‚úÖ Booster activado con √©xito. ¬°Suerte!`);
        
        state.running = true;
        state.activeBooster = boosterType;
        state.afkStart = Date.now();
        state.sessionPoints = 0;
        state.secondsAFK = 0;
        toggleViews(true);
        log('Modo de Recompensas iniciado.');
        loop = setInterval(() => {
          state.secondsAFK = (Date.now() - state.afkStart) / 1000;
          if (Math.floor(state.secondsAFK) > 0 && Math.floor(state.secondsAFK) % 3 === 0) {
            const reward = calculateRewardDrop();
            if (reward.points > 0) { state.sessionPoints += reward.points; log(reward.msg); }
          }
          render();
        }, 1000);
      } catch (error) {
        console.error("Error en la transacci√≥n:", error);
        log(`‚ùå La transacci√≥n fall√≥. Aseg√∫rate de tener suficientes SOLX y SOL para las tasas.`);
      }
    }
    
    async function stopAFK(reason = 'bot√≥n Detener') {
      if(!state.running) return;
      clearInterval(loop);
      state.running = false;
      const gained = Math.floor(state.sessionPoints);
      state.totalPoints += gained;
      localStorage.setItem('afk_total_points', state.totalPoints);
      log(`Sesi√≥n terminada. Ganaste ${gained} Z‚ÄëPoints. Tu nuevo total es ${state.totalPoints}.`);
      toggleViews(false);
      await savePointsToServer();
      render();
    }

    function toggleViews(showAFK) {
      $('#boosters').style.display = showAFK ? 'none' : 'grid';
      $('#afk-display').style.display = showAFK ? 'block' : 'none';
    }

    function calculateRewardDrop() {
      const booster = BOOSTERS_REWARDS[state.activeBooster];
      const roll = Math.random();
      if (roll < booster.probs.jackpot) { return { points: booster.rewards.jackpot, msg: `üöÄ ¬°¬°¬°JACKPOT!!! +${booster.rewards.jackpot} Z-Points` }; }
      else if (roll < booster.probs.jackpot + booster.probs.high) { return { points: booster.rewards.high, msg: `üíé ¬°DROP √âPICO! +${booster.rewards.high} Z-Points` }; }
      else if (roll < booster.probs.jackpot + booster.probs.high + booster.probs.mid) { return { points: booster.rewards.mid, msg: `üî• ¬°Premio bueno! +${booster.rewards.mid} Z-Points` }; }
      else { return Math.random() < 0.4 ? { points: 0 } : { points: booster.rewards.low, msg: `+${booster.rewards.low} Z-Points` }; }
    }

    async function getRanking(){
      log('Consultando el ranking...');
      try {
        const res = await fetch(`${BACKEND_URL}/ranking`);
        const data = await res.json();
        if(data.ok && data.ranking){
          log('üèÜ Ranking Global:');
          data.ranking.forEach((p, i) => {
            log(`${i+1}. ${p.pubkey.slice(0,4)}...${p.pubkey.slice(-4)} ‚Äî ${p.points} puntos`);
          });
        } else { log(`‚ùå Error al cargar el ranking.`); }
      } catch(err) { log('‚ùå No se pudo conectar con el servidor del ranking.'); }
    }
    
    window.addEventListener('load', () => {
        render();
        fetchSolxPrice();
    });
    
    document.querySelectorAll('.booster-card button').forEach(btn => {
        btn.addEventListener('click', () => startAFK(btn.dataset.booster));
    });
    $('#stop').addEventListener('click', () => stopAFK());
    $('#reset').addEventListener('click', () => { 
        state.totalPoints = 0;
        localStorage.setItem('afk_total_points', '0');
        log('‚úÖ Puntos locales reseteados a 0.'); 
        if(state.pubkey) {
          savePointsToServer();
        }
        render(); 
    });
    $('#connect').addEventListener('click', connectWallet);
    $('#ranking').addEventListener('click', getRanking);
    $('#buyAfk').addEventListener('click', () => {
      log('Abriendo Igniter para comprar el token AFK...');
      window.open(IGNITER_URL, '_blank');
    });

    log('Bienvenido. Conecta tu wallet para cargar tu puntuaci√≥n y empezar a jugar.');
  </script>
</body>
</html>