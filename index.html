<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AFK Mode ‚Äî Accumulate and Win üöÄ</title>
  <style>
    :root {
      --bg: #0b1115; --panel: #0e141a; --panel2: #111a22; --text: #dfe7ef;
      --muted: #9db0c0; --accent: #2bd081; --accent2: #11a372; --danger: #ff4d4d;
      --border: #15202b; --gold: #ffc700;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    a { color: var(--accent); text-decoration: none; }
    .wrap { max-width: 800px; margin: 0 auto; padding: 28px 16px 60px; }
    .title { font-size: 28px; font-weight: 800; letter-spacing: .2px; display: flex; align-items: center; gap: 10px; }
    .sub { color: var(--muted); margin-top: 6px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 18px; margin-top: 24px; }
    .card { background: linear-gradient(180deg, var(--panel), var(--panel2)); border: 1px solid var(--border); border-radius: 18px; padding: 18px; }
    .row { display: flex; gap: 12px; align-items: center; }
    .muted { color: var(--muted); }
    .section-title { font-weight: 700; margin-bottom: 12px; font-size: 18px; }
    .btn {
      border: 1px solid var(--border); background: #101a21; color: var(--text); border-radius: 12px; padding: 11px 14px;
      cursor: pointer; transition: all .15s ease; font-weight: 700; font-size: 14px; width: 100%;
    }
    .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: #041417; border-color: transparent; }
    .btn-danger { background: var(--danger); color: #1f0a0a; border-color: transparent; }
    .btn-play { padding: 16px; font-size: 20px; margin-top: 12px; }
    .kpi { display: flex; flex-direction: column; gap: 4px; padding: 14px; background: #0e171e; border: 1px dashed var(--border); border-radius: 14px; text-align: center; }
    .kpi .v { font-size: 32px; font-weight: 800; color: var(--gold); }
    .kpi-group { display: flex; justify-content: center; gap: 14px; margin-bottom: 16px; }
    .kpi-group .kpi .v { font-size: 22px; color: var(--text); }
    .log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: #091218; border: 1px solid var(--border); border-radius: 14px; padding: 12px; height: 250px; overflow: auto; white-space: pre-wrap;
      font-size: 13px; line-height: 1.6;
    }
    #ranking-list { padding-left: 20px; margin: 0; list-style-type: none; }
    #ranking-list li { margin-bottom: 8px; font-size: 15px; display: flex; align-items: center; gap: 10px; }
    #ranking-list li span { font-weight: 600; color: var(--muted); width: 25px; text-align: right; }
    /* Modal */
    .modal-backdrop{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;justify-content:center;align-items:center}
    .modal{position:relative;max-width:420px;width:95%;background:var(--panel);border-radius:18px;padding:10px}
    .modal-close{position:absolute;top:-15px;right:-15px;background:var(--danger);color:#fff;border:none;border-radius:50%;width:30px;height:30px;font-size:16px;cursor:pointer}
    .jup-frame{width:100%;height:560px;border:0;border-radius:12px;overflow:hidden;background:#0b1115}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">AFK Mode ‚Äî Accumulate and Win üöÄ</div>
    <div class="sub">Buy $AFK to accumulate game time. The more you buy, the longer the game will last and the better the prizes will be!</div>

    <div class="grid">
      <div class="card" id="admin-panel" style="display: none;">
        <div class="section-title">‚öôÔ∏è Admin Panel</div>
        <button id="resetWeeklyBtn" class="btn btn-danger">Reset All Scores</button>
      </div>

      <div class="card">
        <div class="section-title">Control Panel</div>
        <div class="row">
          <button id="connect" class="btn">1. Connect Wallet</button>
          <button id="swapButton" class="btn btn-primary" disabled>2. Buy / Sell $AFK</button>
        </div>
        <div id="pubkey" class="muted" style="text-align:center; margin-top:12px; font-size:13px;">Wallet not connected</div>
      </div>

      <div id="swap-modal" class="modal-backdrop">
        <div class="modal">
          <iframe id="jup-frame" class="jup-frame" allow="clipboard-read; clipboard-write" title="Jupiter Terminal"></iframe>
          <button id="close-swap" class="modal-close">&times;</button>
        </div>
      </div>

      <div class="card" id="game-panel">
        <div id="play-mode">
          <div class="section-title">Game Zone</div>
          <div class="kpi" style="margin-bottom: 16px;">
            <div class="muted">Available Game Time</div>
            <div id="unclaimedTime" class="v">0:00</div>
          </div>
          <button id="playButton" class="btn btn-primary btn-play" disabled>PLAY</button>
        </div>

        <div id="afk-display" style="display: none;">
          <div class="section-title">Active Game Session</div>
          <div class="kpi-group">
            <div class="kpi"><div class="muted">Time Remaining</div><div id="afkTime" class="v">0:00</div></div>
            <div class="kpi"><div class="muted">Session Points</div><div id="pointsSession" class="v">0</div></div>
          </div>
        </div>
      </div>
      
      <div class="card">
         <div class="section-title">Total Score</div>
         <div class="kpi"><div id="pointsTotal" class="v">0</div></div>
      </div>

      <div class="card">
        <div class="section-title">üèÜ Player Ranking (Top 10)</div>
        <div style="font-size: 14px; color: var(--gold); background: #1a1a0b; padding: 12px 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; line-height: 1.6;">
          <p style="margin: 0 0 10px 0;">
            <b>Grand Prize!</b> The top 3 players will receive their prizes when the project reaches the 1,000,000 SOLX migration threshold.
          </p>
          <div style="display: inline-block; text-align: left;">
            ü•á <b>1st Place:</b> 50% of the Prize Pool<br>
            ü•à <b>2nd Place:</b> 30% of the Prize Pool<br>
            ü•â <b>3rd Place:</b> 20% of the Prize Pool
          </div>
        </div>
        <ol id="ranking-list">
          <li>Loading ranking...</li>
        </ol>
      </div>

      <div class="card">
        <div class="section-title">Activity Log</div>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

<script>
    // ========= CONFIGURATION =========
    const BACKEND_URL = "https://api.afkcoin.xyz";
    const ADMIN_PUBKEY = "F3zY8TZ9jiCTneBkPQr1DMbyT9vgwdBUXCoZB9h4GP5G";
    const WORKER_BASE = "https://afk-balance-worker.afkcoin.workers.dev";
    const AFK_DETECT_URL = `${WORKER_BASE}/afkRecentBuy`;
    const DETECT_INTERVAL_MS = 8000;
    const DETECT_WINDOW_MIN = 30;
    const RANKING_URL = `${BACKEND_URL}/ranking`;
    const RANKING_REFRESH_MS = 30000;

    // --- JUPITER CONFIG (TEST) ---
    const JUP_CONFIG = {
      inputMint: "So11111111111111111111111111111111111111112",   // SOL
      // Temporary change for testing: using USDC instead of AFK
      outputMint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyB7u6T", // USDC Mint Address
      passThroughWallet: "true"
    };

    // --- Tier and Reward Definitions ---
    const TIERS = {
        legendary: { minAmount: 2500, seconds: 300, name: "Legendary" },
        rare:      { minAmount: 500,  seconds: 180, name: "Rare" },
        basic:     { minAmount: 1,    seconds: 60,  name: "Basic" }
    };
    const tierPrecedence = ['basic', 'rare', 'legendary'];
    const REWARDS_CONFIG = {
        basic: { rewards: { jackpot: 1000, high: 200, mid: 50, low: 10 }, probs: { jackpot: 0.01, high: 0.05, mid: 0.2 } },
        rare: { rewards: { jackpot: 10000, high: 1000, mid: 250, low: 50 }, probs: { jackpot: 0.02, high: 0.08, mid: 0.25 } },
        legendary: { rewards: { jackpot: 250000, high: 5000, mid: 1000, low: 200 }, probs: { jackpot: 0.005, high: 0.1, mid: 0.3 } },
    };

    // --- Application State ---
    const state = { pubkey: null, running: false, purchaseDetector: null, unclaimedSeconds: 0, highestTier: null, totalPoints: 0, afkStart: null, sessionDuration: 0, sessionTier: null, sessionPoints: 0 };
    const $ = sel => document.querySelector(sel);
    const log = (msg) => { const box = $('#log'); const t = new Date().toLocaleTimeString(); box.innerHTML = `[${t}] ${msg}<br>` + box.innerHTML; };
    const fmt = (s) => { const m = Math.floor(s / 60), ss = String(Math.floor(s % 60)).padStart(2, '0'); return `${m}:${ss}` };

    function render() {
        $('#unclaimedTime').textContent = fmt(state.unclaimedSeconds);
        $('#playButton').disabled = !state.pubkey || state.running || state.unclaimedSeconds <= 0;
        $('#pointsTotal').textContent = state.totalPoints.toFixed(0);
        if (state.running) {
            const elapsed = (Date.now() - state.afkStart) / 1000;
            const remaining = Math.max(0, state.sessionDuration - elapsed);
            $('#afkTime').textContent = fmt(remaining);
            $('#pointsSession').textContent = state.sessionPoints.toFixed(0);
        }
    }

    // --- PURCHASE DETECTION LOGIC ---
    function alreadyRewarded(sig) { try { return localStorage.getItem(`afk_bonus_${sig}`) === "1"; } catch { return false; } }
    function markRewarded(sig) { try { localStorage.setItem(`afk_bonus_${sig}`, "1"); } catch { } }
    async function checkRecentPurchase(pubkey) {
        try {
            const r = await fetch(`${AFK_DETECT_URL}?pubkey=${encodeURIComponent(pubkey)}&minutes=${DETECT_WINDOW_MIN}`);
            const j = await r.json();
            if (j && j.ok && j.purchased) return j;
        } catch (e) { console.error("Error checking purchase:", e); }
        return null;
    }
    async function purchaseDetectionLoop() {
        if (!state.pubkey || state.running) return;
        log('üîé Searching for $AFK purchases...');
        const purchase = await checkRecentPurchase(state.pubkey);
        if (purchase && !alreadyRewarded(purchase.signature)) {
            markRewarded(purchase.signature);
            
            let tierId = null;
            if (purchase.amount >= TIERS.legendary.minAmount) tierId = 'legendary';
            else if (purchase.amount >= TIERS.rare.minAmount) tierId = 'rare';
            else if (purchase.amount >= TIERS.basic.minAmount) tierId = 'basic';

            if(tierId) {
                const tierInfo = TIERS[tierId];
                state.unclaimedSeconds += tierInfo.seconds;
                log(`‚úÖ Purchase detected! You've earned ${tierInfo.seconds}s of game time (Tier: ${tierInfo.name}).`);
                
                if (!state.highestTier || tierPrecedence.indexOf(tierId) > tierPrecedence.indexOf(state.highestTier)) {
                    state.highestTier = tierId;
                    log(`‚ú® Your next game will have ${tierInfo.name} level rewards.`);
                }
                render();
            }
        }
    }
    function startPurchaseDetector() {
        if (state.purchaseDetector) clearInterval(state.purchaseDetector);
        state.purchaseDetector = setInterval(purchaseDetectionLoop, DETECT_INTERVAL_MS);
        log('Purchase detector activated.');
    }
    function stopPurchaseDetector() {
        if (state.purchaseDetector) { clearInterval(state.purchaseDetector); state.purchaseDetector = null; log('Purchase detector paused.'); }
    }
    
    // --- GAME LOGIC ---
    function toggleViews(showAFK) {
        $('#play-mode').style.display = showAFK ? 'none' : 'block';
        $('#afk-display').style.display = showAFK ? 'block' : 'none';
    }
    function calculateRewardDrop(tier) {
        const config = REWARDS_CONFIG[tier]; const roll = Math.random();
        if (roll < config.probs.jackpot) return { points: config.rewards.jackpot, msg: `üöÄ JACKPOT!! +${config.rewards.jackpot}` };
        if (roll < config.probs.jackpot + config.probs.high) return { points: config.rewards.high, msg: `üíé EPIC DROP! +${config.rewards.high}` };
        if (roll < config.probs.jackpot + config.probs.high + config.probs.mid) return { points: config.rewards.mid, msg: `üî• Nice prize! +${config.rewards.mid}` };
        return Math.random() < 0.4 ? { points: 0 } : { points: config.rewards.low, msg: `+${config.rewards.low}` };
    }
    let gameLoop;
    function startAFK() {
        if (state.running || state.unclaimedSeconds <= 0) return;
        state.sessionDuration = state.unclaimedSeconds; state.sessionTier = state.highestTier || 'basic';
        state.unclaimedSeconds = 0; state.highestTier = null; state.running = true; state.afkStart = Date.now();
        state.sessionPoints = 0; toggleViews(true); log(`üöÄ Game started! Duration: ${fmt(state.sessionDuration)}, Tier: ${TIERS[state.sessionTier].name}`);
        stopPurchaseDetector();
        gameLoop = setInterval(() => {
            const elapsedSeconds = (Date.now() - state.afkStart) / 1000;
            const lastRewardCheck = Math.floor((elapsedSeconds - 1) / 3);
            const currentRewardCheck = Math.floor(elapsedSeconds / 3);
            if (currentRewardCheck > lastRewardCheck) {
                const reward = calculateRewardDrop(state.sessionTier);
                if (reward.points > 0) { state.sessionPoints += reward.points; log(reward.msg); }
            }
            if (elapsedSeconds >= state.sessionDuration) { stopAFK(); } else { render(); }
        }, 1000);
    }
    async function stopAFK() {
        if (!state.running) return; clearInterval(gameLoop); state.running = false;
        state.totalPoints += state.sessionPoints; log(`üèÅ Session ended. You earned ${state.sessionPoints} points. Total: ${state.totalPoints}`);
        toggleViews(false);
        if (state.pubkey) { startPurchaseDetector(); await savePointsToServer(); await fetchRanking(); }
        render();
    }

    // --- RANKING LOGIC ---
    function renderRanking(rankingData) {
        const list = $('#ranking-list');
        const filteredRanking = rankingData ? rankingData.filter(player => player.pubkey !== ADMIN_PUBKEY) : [];
        if (filteredRanking.length === 0) { list.innerHTML = '<li>No one is on the ranking yet. Be the first! üèÜ</li>'; return; }
        const topEmojis = ['ü•á', 'ü•à', 'ü•â'];
        list.innerHTML = filteredRanking.slice(0, 10).map((player, index) => {
            const key = player.pubkey; const truncatedKey = `${key.slice(0, 4)}‚Ä¶${key.slice(-4)}`;
            const emoji = topEmojis[index] || `<span>#${index + 1}</span>`;
            return `<li>${emoji} ${truncatedKey} - <strong>${player.points.toFixed(0)} Points</strong></li>`;
        }).join('');
    }
    async function fetchRanking() {
        try {
            const res = await fetch(RANKING_URL);
            if (!res.ok) throw new Error(`Server responded with status ${res.status}`);
            const result = await res.json(); renderRanking(result);
        } catch (err) { log('‚ùå Could not load the ranking.'); console.error("Error fetching ranking:", err); $('#ranking-list').innerHTML = '<li>Error loading ranking.</li>'; }
    }

    // --- CONNECTION & SERVER ---
    async function connectWallet() {
        const provider = window.solana;
        if (!provider || !provider.isPhantom) { log('‚ùå Phantom Wallet not detected. Please install it.'); return; }
        try {
            const resp = await provider.connect(); const key = resp.publicKey.toString(); state.pubkey = key;
            $('#pubkey').textContent = `Wallet: ${key.slice(0, 4)}‚Ä¶${key.slice(-4)}`; log('‚úÖ Wallet connected.');
            if (key === ADMIN_PUBKEY) { log('üëã Hello, Admin! Control panel activated.'); $('#admin-panel').style.display = 'block'; }
            else { $('#admin-panel').style.display = 'none'; }
            await loadPointsFromServer(key); startPurchaseDetector(); purchaseDetectionLoop();
            $('#swapButton').disabled = false;
        } catch (err) { log('‚ùå Connection rejected by user.'); }
    }
    async function loadPointsFromServer(pubkey) {
        try {
            const res = await fetch(`${BACKEND_URL}/points/${pubkey}`);
            if (res.ok) { const data = await res.json(); state.totalPoints = data.points || 0; log(`Total score loaded: ${state.totalPoints}`); }
            else { log('New wallet. Welcome!'); state.totalPoints = 0; }
        } catch (err) { log('‚ùå Could not connect to the score server.'); state.totalPoints = 0; }
        finally { render(); }
    }
    async function savePointsToServer() {
        if (!state.pubkey) return;
        try {
            await fetch(`${BACKEND_URL}/savePoints`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pubkey: state.pubkey, points: state.totalPoints }) });
            log('Score saved to server.');
        } catch (err) { log('‚ùå Could not sync score.'); }
    }

    // --- ADMIN FUNCTIONS ---
    async function resetAllScores() {
      if (!confirm('Are you sure you want to reset the points of ALL players to zero? This will start a new season.')) { return; }
      log('‚öôÔ∏è Resetting all scores...');
      try {
        const res = await fetch(`${BACKEND_URL}/resetWeekly`, { method: 'POST' }); const data = await res.json();
        if (res.ok && data.ok) { log('‚úÖ All scores have been reset.'); await fetchRanking(); }
        else { throw new Error(data.error || 'Non-OK response from server'); }
      } catch (err) { log('‚ùå Error resetting scores.'); console.error('Reset error:', err); }
    }

    // --- JUPITER LAUNCHER (IFRAME METHOD) ---
    function objectToQueryString(obj) {
        return Object.entries(obj).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
    }

    function launchJupiter() {
        const queryString = objectToQueryString(JUP_CONFIG);
        const url = `https://jup.ag/swap?${queryString}`;
      
        $('#jup-frame').src = url;
        $('#swap-modal').style.display = "flex";
        log("üöÄ Jupiter Terminal opened.");
        setTimeout(() => purchaseDetectionLoop(), 4000);
    }

    // --- INITIALIZATION ---
    $('#connect').addEventListener('click', connectWallet);
    $('#playButton').addEventListener('click', startAFK);
    $('#resetWeeklyBtn').addEventListener('click', resetAllScores);
    $('#swapButton').addEventListener('click', launchJupiter);
    $('#close-swap').addEventListener('click', () => {
        $('#swap-modal').style.display = 'none';
        $('#jup-frame').src = "about:blank"; // Clear iframe to stop connections
    });
    log('Welcome. Connect your wallet to start.');
    render(); fetchRanking(); setInterval(fetchRanking, 30000);
</script>
</body>
</html>